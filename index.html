<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ações ACR - CMPC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: CMPC Green & Gray -->
    <!-- Application Structure Plan: A single-page dashboard structure was chosen to provide a comprehensive and immediate overview of the ACR actions. The structure includes: 1) High-level Key Performance Indicators (KPIs) at the top for total overdue and upcoming actions, offering instant insight. 2) A tab-based navigation system to switch between "Atrasadas" and "A Vencer" views, directly addressing the user's request for two distinct dashboards while maintaining a cohesive user experience. 3) A dynamic content area that updates based on the selected tab, featuring a horizontal bar chart for a quick visual comparison of actions by department, and a detailed, sortable table for in-depth analysis. This design prioritizes usability by presenting information in layers—from summary to detail—allowing users to explore the data intuitively without being overwhelmed. -->
    <!-- Visualization & Content Choices: 1) KPIs (Total Atrasadas, Total a Vencer): Goal: Inform. Method: Styled HTML/Tailwind cards. Interaction: None. Justification: Provides immediate, high-impact summary statistics. 2) Actions per Department: Goal: Compare. Method: Horizontal Bar Chart with data labels. Interaction: Hover tooltips. Justification: Effectively compares quantities across different departments, accommodating potentially long names and providing exact numbers on bars. Library: Chart.js (Canvas). 3) Detailed Action List: Goal: Organize & Inform. Method: Visually grouped HTML Table with expandable rows showing a one-ACR-to-many-PAs hierarchy. Interaction: Tab-switching, column sorting, and row expansion to reveal sub-tasks. Justification: Presents structured data in clear, thematic blocks, with progressive disclosure for detailed sub-actions, improving readability and preventing information overload. Method: HTML/Tailwind + Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f5; /* Zinc 100 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 450px; /* Increased height */
            max-height: 60vh; /* Increased max-height */
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .tab-active {
            border-bottom-color: #006437; /* Dark Green */
            color: #006437; /* Dark Green */
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom-color: transparent;
            color: #52525b; /* Zinc 600 */
        }
        th, .clickable-row {
            cursor: pointer;
        }
        th:hover .sort-indicator {
            opacity: 0.7;
        }
        .details-row {
            display: none;
        }
        .details-row.show {
            display: table-row;
        }
        .details-cell {
            background-color: #fafafa;
            padding: 1rem 1.5rem;
            border-left: 3px solid #008744;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Relatório Interativo de Ações ACR</h1>
            <p class="text-gray-600 mt-2">Navegue pelos dados de ações atrasadas e a vencer.</p>
        </header>

        <main>
            <section id="kpis" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 text-center">
                    <h2 class="text-lg font-semibold text-red-600">Total de PAs Atrasados</h2>
                    <p id="total-atrasadas" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 text-center">
                    <h2 class="text-lg font-semibold text-amber-600">Total de PAs a Vencer (&lt;30 dias)</h2>
                    <p id="total-a-vencer" class="text-4xl font-bold mt-2">0</p>
                </div>
            </section>

            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md border border-gray-200">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex -mb-px space-x-6">
                        <button id="tab-atrasadas" class="py-4 px-1 border-b-2 text-sm sm:text-base tab-active">Ações Atrasadas</button>
                        <button id="tab-a-vencer" class="py-4 px-1 border-b-2 text-sm sm:text-base tab-inactive">Ações a Vencer</button>
                    </nav>
                </div>

                <div id="content-area">
                    <div id="intro-text" class="mb-6 text-gray-600">
                        <p>Esta seção apresenta uma análise detalhada. Clique em uma linha para expandir e ver os Planos de Ação (PAs) associados à ACR.</p>
                    </div>
                    <div class="chart-container mb-8">
                        <canvas id="acrChart"></canvas>
                    </div>
                    <div class="overflow-x-auto">
                         <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="w-2/5 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="responsavel">Responsável <span class="sort-indicator opacity-0 transition-opacity">↕️</span></th>
                                    <th scope="col" class="w-2/5 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="acr">ACR <span class="sort-indicator opacity-0 transition-opacity">↕️</span></th>
                                    <th scope="col" class="w-1/5 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="data">Vencimento <span class="sort-indicator opacity-0 transition-opacity">↕️</span></th>
                                </tr>
                            </thead>
                            <tbody id="acrTableBody" class="bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Dashboard gerado em <span id="generation-date"></span>.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CMPC_DARK_GREEN = '#006437';
            const CMPC_GRAY = '#52525b';
            
            const rawData = [
                { gerencia: 'FACEPA', responsavel: 'Marcio Leal Araujo', acrFull: '002155 - Colisão da empilhadeira com portão lado norte - Defapa', paId: 'PA N° - 02657 - 000002', paDesc: 'Pintar com tinta sinalizadora na barra de deslizamento do portão, a altura limitadora do portão para passagem da empilhadeira', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'FACEPA', responsavel: 'Marcio Leal Araujo', acrFull: '002155 - Colisão da empilhadeira com portão lado norte - Defapa', paId: 'PA N° - 02657 - 000005', paDesc: 'Sinalizar tubulação em frente ao portão norte para visualização dos operadores de', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'FACEPA', responsavel: 'Mauricio Carvalho Malka', acrFull: '002155 - Colisão da empilhadeira com portão lado norte - Defapa', paId: 'PA N° - 02657 - 000003', paDesc: 'Reciclagem e instrução aos Operadores de empilhadeira da Defapa sobre a altura correta de passagem das empilhadeiras sobre os portões', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Arlan Soares Bossle', acrFull: '002177 - Vazamento de Soda 20% pela junta após o 728-FI-0105', paId: 'PA N° - 02748 - 000001', paDesc: 'Realizar inspeção da tubulação, verificando a especificação correta das juntas.', status: 'Atrasada', data: '2025-09-26' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Arlan Soares Bossle', acrFull: '002177 - Vazamento de Soda 20% pela junta após o 728-FI-0105', paId: 'PA N° - 02748 - 000002', paDesc: 'Definir plano de substituição das juntas fora de especificação verificadas em inspeção.', status: 'Atrasada', data: '2025-09-26' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Ruberval Roduit Ramos', acrFull: '002148 - Falha na botoeira de emergência do Capô da pré-secagem', paId: 'PA N° - 02653 - 000001', paDesc: 'Realizar um estudo para Retrofit do sistema de iluminação interna da capota', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Ruberval Roduit Ramos', acrFull: '002148 - Falha na botoeira de emergência do Capô da pré-secagem', paId: 'PA N° - 02653 - 000002', paDesc: 'Realizar um estudo para rebaixar o sistema de iluminação da capota para extra baixa tensão.', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'PROCESSOS E QUALIDADE', responsavel: 'Michel Ferreira Costa', acrFull: '002138 - Desclassificação de polpa por Sujidade em G2 no dia 20/08', paId: 'PA N° - 02645 - 000003', paDesc: 'Estudar, avaliar e implementar controle de análise para quantificação de rejeito das amostras dos depuradores junto ao laboratório e definir rotina de análise.', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'PROCESSOS E QUALIDADE', responsavel: 'Rodrigo Silva Leite', acrFull: '002119 - Quebra de faca do picador 2 e parada da LDF 1 por contaminação de madeira com pedra', paId: 'PA N° - 02622 - 000001', paDesc: 'Desenvolver projeto de madeira pré-corte junto com a universidade UFRRJ.', status: 'Atrasada', data: '2025-09-01' },
                { gerencia: 'DEFACE', responsavel: 'Marcelo Rodrigues Ferreira', acrFull: '002032 - Vazamento de óleo no cilindro de acionamento da prensa de sapatas estendidas', paId: 'PA N° - 02560 - 000008', paDesc: 'Programar lavagem química da prensa EP.', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'ENGENHARIA', responsavel: 'Marcelo Custodio Stahl', acrFull: '002308 - Troca de feltro pick up prematuramente', paId: 'PA N° - 02308 - 000006', paDesc: 'Trocar a posição do apalpador para melhor acesso da operação', status: 'Atrasada', data: '2025-09-30' },
                { gerencia: 'GERENCIA INDUSTRIAL', responsavel: 'Wanicley Walas Viana', acrFull: '002002 - Vazamento de dióxido de cloro para atmosfera', paId: 'PA N° - 02257 - 000008', paDesc: 'Promover treinamentos de consciência situacional baseada em confiabilidade humana da aviação. (Adicionar o módulo Situational Awareness ao projeto de confiabilidade humana)', status: 'Atrasada', data: '2025-03-21' },
                { gerencia: 'FACEPA', responsavel: 'Anderson Silveira de Souza', acrFull: '002179 - Princípio de incêndio nas canaletas da MS2', paId: 'PA N° - 02746 - 000002', paDesc: 'Incluir sistema de monitoramento', status: 'A Vencer', data: '2025-10-20' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Arlan Soares Bossle', acrFull: '002177 - Vazamento de Soda 20% pela junta após o 728-FI-0105', paId: 'PA N° - 02748 - 000003', paDesc: 'Treinar a equipe de execução no P-PC-0592 - Substituição de juntas em ligações flangeadas.', status: 'A Vencer', data: '2025-10-03' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Ruberval Roduit Ramos', acrFull: '002151 - Queima recorrente de lâmpadas da iluminação interna da capota da Pré-secagem', paId: 'PA N° - 02654 - 000001', paDesc: 'Buscar viabilidade financeira/técnica para realizar retrofit do sistema de iluminação interna da capota da Pré e Pós secagem da Máquina de Papel Defapa.', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Ruberval Roduit Ramos', acrFull: '002151 - Queima recorrente de lâmpadas da iluminação interna da capota da Pré-secagem', paId: 'PA N° - 02654 - 000002', paDesc: 'Buscar viabilidade financeira/técnica para realizar estudo para rebaixar o sistema de iluminação da capota para extra baixa tensão', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Pedro Lucas Ferreira Ferrari', acrFull: '002173 - Parada do Digestor por Falha do Ventilador de Gás HVLC - 578-24-040', paId: 'PA N° - 02751 - 000002', paDesc: 'Realizar CRP da execução da estratégia de inspeção sensitiva.', status: 'A Vencer', data: '2025-10-02' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Pedro Lucas Ferreira Ferrari', acrFull: '002173 - Parada do Digestor por Falha do Ventilador de Gás HVLC - 578-24-040', paId: 'PA N° - 02751 - 000003', paDesc: 'Orientar equipe quanto ao armazenamento do Checklist das inspeções nas ordens de manutenção ao finalizar a tarefa.', status: 'A Vencer', data: '2025-10-02' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Erick Alex Silva Pacheco', acrFull: '002117 - ACR - IOCA Sério Vazamento de tubulação de efluente atingindo o solo e Lago Guaíba', paId: 'PA N° - 02117 - 000006', paDesc: 'Criar e implementar estratégia de inspeção para redes subterrâneas junto a disciplina de civil.Verificar os recursos, tarefas e oportunidades de execução e implementar estratégia por meio de planos de manutenção', status: 'A Vencer', data: '2025-10-03' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Erick Alex Silva Pacheco', acrFull: '002167 - Falha no Redutor da Translação Silo Leste 354-27-152', paId: 'PA N° - 02736 - 000001', paDesc: 'Realizar informativo junto à equipe da Oficina Central sobre o evento de falha do eixo', status: 'A Vencer', data: '2025-10-03' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002008 - Vazamentos do sistema de lavagem Evaporação G2', paId: 'PA N° - 02258 - 000005', paDesc: 'Verificar se as suportações do sistema de Lavagem da Evaporação G2 estão conforme projeto', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002110 - Digestor reduzido devido a níveis elevado de polpa em decorrência da quebra do acoplamento do eixo de acionamento do rolo P102', paId: 'PA N° - 02618 - 000007', paDesc: 'Realizar a notificação da SKF', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002173 - Parada do Digestor por Falha do Ventilador de Gás HVLC - 578-24-040', paId: 'PA N° - 02751 - 000001', paDesc: 'Realizar notificação de não conformidade para SKF da falha do Ventilador de Gás HVLC 578-24-040', status: 'A Vencer', data: '2025-10-03' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002181 - Falha Rolamento Rolo Fixo (Lado Acionado) Prensa 762-28-021', paId: 'PA N° - 02767 - 000001', paDesc: 'Reestruturar análises de óleo de forma visual (interna) com periodicidade reduzida', status: 'A Vencer', data: '2025-10-17' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002181 - Falha Rolamento Rolo Fixo (Lado Acionado) Prensa 762-28-021', paId: 'PA N° - 02767 - 000002', paDesc: 'Identificar e repriorizar a rotina do Inspetor de Lubrificação CMPC', status: 'A Vencer', data: '2025-10-10' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Odair do Amaral Lima', acrFull: '002181 - Falha Rolamento Rolo Fixo (Lado Acionado) Prensa 762-28-021', paId: 'PA N° - 02767 - 000005', paDesc: 'Retomar a rotina de aplicação da técnica de Shock Pulse nas Prensas', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Veronica de Lima Correa', acrFull: '002154 - Digestor G1 parado devido parada da MS1 (Falha no acoplamento do motor da bomba de vácuo 465-37-090 dia 10/08/2025)', paId: 'PA N° - 02710 - 000009', paDesc: 'Implementar / reforçar com o time de planejamento a necessidade da utilização de check-lists após atividades de manutenção em PP', status: 'A Vencer', data: '2025-10-03' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Heleno dos Santos Pereira', acrFull: '002110 - Digestor reduzido devido a níveis elevado de polpa em decorrência da quebra do acoplamento do eixo de acionamento do rolo P102', paId: 'PA N° - 02618 - 000001', paDesc: 'Desenvolver procedimento de lubrificação de acoplamentos', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Heleno dos Santos Pereira', acrFull: '002110 - Digestor reduzido devido a níveis elevado de polpa em decorrência da quebra do acoplamento do eixo de acionamento do rolo P102', paId: 'PA N° - 02618 - 000002', paDesc: 'Atualizar procedimento de lubrificação considerando a primeira lubrificação dos acoplamentos', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Heleno dos Santos Pereira', acrFull: '002110 - Digestor reduzido devido a níveis elevado de polpa em decorrência da quebra do acoplamento do eixo de acionamento do rolo P102', paId: 'PA N° - 02618 - 000004', paDesc: 'Atualizar plano de lubrificação (SKF) com troca do lubrificante (anual)', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Heleno dos Santos Pereira', acrFull: '002167 - Falha no Redutor da Translação Silo Leste 354-27-152', paId: 'PA N° - 02736 - 000002', paDesc: 'Incluir no sistema o ponto de lubrificação do rolamento superior do eixo de saída (abrangência para demais silos)', status: 'A Vencer', data: '2025-10-10' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Jean Silva da Silveira', acrFull: '002141 - Rompimento da linha de água branca 763-WAA-0001-0400-10H41', paId: 'PA N° - 02661 - 000003', paDesc: 'Implantar estratégia de inspeção termográfica ou microondas da tubulação de fibra 763-WAA-001-0400-10H41', status: 'A Vencer', data: '2025-10-10' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Jean Silva da Silveira', acrFull: '002173 - Parada do Digestor por Falha do Ventilador de Gás HVLC - 578-24-040', paId: 'PA N° - 02751 - 000005', paDesc: 'Identificar desenho técnico e Desenvolver fornecedor do Cone do Ventilador de Gás HVLC 578-24-040', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Mauricio Rodrigues', acrFull: '002081 - Parada do Peneiramento G2 - Falha nas Peneiras 754-28-400/404', paId: 'PA N° - 02598 - 000001', paDesc: 'Revisitar o plano de manutenção quanto a sua execução e detalhamento', status: 'A Vencer', data: '2025-10-15' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Mauricio Rodrigues', acrFull: '002157 - Parada da depuração marrom G2 no dia 11/08/25 para inspeção e limpeza no stand-pipe da bomba MC 762-28-055 devido baixa eficiência da bomba', paId: 'PA N° - 02677 - 000003', paDesc: 'Criar Plano de inspeção para as juntas de expansão', status: 'A Vencer', data: '2025-10-24' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Bismark Ribeiro de Souza', acrFull: '002139 - Queima do motor do ventilador do LE 756-27-020', paId: 'PA N° - 02652 - 000001', paDesc: 'Criar estratégia manutenção para os ventiladores (substituição por tempo)', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Bismark Ribeiro de Souza', acrFull: '002139 - Queima do motor do ventilador do LE 756-27-020', paId: 'PA N° - 02652 - 000002', paDesc: 'Criar/Inserir TAG em plano de manutenção preventiva', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Edson Luiz Rossa', acrFull: '002164 - Parada do digestor após TRIP na CR1 - 571-28-001 do dia 26/08', paId: 'PA N° - 02740 - 000001', paDesc: 'Plano de inspeção preventiva (testes de acionamento) Criar plano', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'MANUTENÇÃO', responsavel: 'Leandro Pia Leite', acrFull: '002135 - Falha na chapa perfurada lado B da prensa 763-28-039', paId: 'PA N° - 02650 - 000004', paDesc: 'Incluir chapa perfurada no almoxarifado', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'PROCESSOS E QUALIDADE', responsavel: 'Rodrigo Silva Leite', acrFull: '001819 - Desclassificação por Alvura e Sujidade em G1 do dia 24 ao dia 27 de junho de 2024', paId: 'PA N° - 02010 - 000004', paDesc: 'Definir plano de tratamento definitivo anti pitch para G1 com skid definitivo.', status: 'A Vencer', data: '2025-10-30' },
                { gerencia: 'DEFACE', responsavel: 'Jarbas Luis Curtinaz Pereira Junior', acrFull: '002183 - ACR QUASE ACIDENTE - GUARDA CORPO SOLTO EM ÁREA', paId: 'PA N° - 02763 - 000002', paDesc: 'Conforme retorno da ação anterior, inserir ação para representantes de caldeiraria e/ou confiabilidade e/ou manutenção.', status: 'A Vencer', data: '2025-10-04' },
                { gerencia: 'DEFACE', responsavel: 'Jose Silveira Fechner', acrFull: '002165 - Desalinhamento Transportador 756-26-421', paId: 'PA N° - 02680 - 000002', paDesc: 'Realizar a verificação das rotas de GRO existentes para garantir que todos os pontos passíveis de vazamento estejam sendo acompanhados', status: 'A Vencer', data: '2025-10-29' },
                { gerencia: 'ENGENHARIA', responsavel: 'Mario Luis de Souza Terres', acrFull: '001973 - Abertura da PSV do Trocador 578-28-031', paId: 'PA N° - 02133 - 000001', paDesc: 'Executar solução definitiva para descarga da PSV do trocador 578-28-031', status: 'A Vencer', data: '2025-10-30' }
            ];

            const processRawData = (data) => {
                const groupedByRespAndAcr = data.reduce((acc, item) => {
                    const key = `${item.responsavel}|${item.acrFull}`;
                    if (!acc[key]) {
                        acc[key] = {
                            gerencia: item.gerencia,
                            responsavel: item.responsavel,
                            data: item.data,
                            acr: item.acrFull.startsWith('00') ? item.acrFull.substring(2) : item.acrFull,
                            acrFull: item.acrFull,
                            pas: []
                        };
                    }
                    acc[key].pas.push({ id: item.paId, desc: item.paDesc });
                    return acc;
                }, {});
                return Object.values(groupedByRespAndAcr);
            };

            const dadosAtrasados = processRawData(rawData.filter(d => d.status === 'Atrasada'));
            const dadosAVencer = processRawData(rawData.filter(d => d.status === 'A Vencer'));

            let chartInstance = null;
            let currentView = 'atrasadas';
            let currentSort = { column: 'responsavel', direction: 'asc' };

            const tabAtrasadas = document.getElementById('tab-atrasadas');
            const tabAVencer = document.getElementById('tab-a-vencer');
            const tableBody = document.getElementById('acrTableBody');
            const tableHeaders = document.querySelectorAll('th[data-sort]');
            const totalAtrasadasEl = document.getElementById('total-atrasadas');
            const totalAVencerEl = document.getElementById('total-a-vencer');

            const datalabelsPlugin = { id: 'customDatalabels', afterDatasetsDraw(chart) { const { ctx } = chart; ctx.save(); ctx.font = '600 12px Inter'; ctx.fillStyle = CMPC_GRAY; ctx.textAlign = 'left'; ctx.textBaseline = 'middle'; for (let i = 0; i < chart.data.datasets.length; i++) { const meta = chart.getDatasetMeta(i); if (!meta.hidden) { meta.data.forEach((element, index) => { const data = chart.data.datasets[i].data[index]; ctx.fillText(data, element.x + 8, element.y); }); } } ctx.restore(); } };
            Chart.register(datalabelsPlugin);

            const calculatePAs = (data) => data.reduce((sum, item) => sum + item.pas.length, 0);

            const processDataForChart = (data) => {
                const grouped = data.reduce((acc, item) => {
                    acc[item.gerencia] = (acc[item.gerencia] || 0) + item.pas.length;
                    return acc;
                }, {});
                const labels = Object.keys(grouped).sort((a, b) => grouped[b] - grouped[a]);
                const values = labels.map(label => grouped[label]);
                return { labels, values };
            };

            const renderChart = (data, label, color) => {
                const { labels, values } = processDataForChart(data);
                const ctx = document.getElementById('acrChart').getContext('2d');
                if (chartInstance) { chartInstance.destroy(); }
                chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: label, data: values, backgroundColor: color, borderColor: color, borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => ` Qtd PAs: ${context.raw}` } } }, scales: { x: { display: false, beginAtZero: true }, y: { grid: { display: false } } }, layout: { padding: { right: 30 } } } });
            };

            const formatDate = (dateString) => { const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };

            const sortData = (data, sortConfig) => {
                return [...data].sort((a, b) => {
                    let aVal = a[sortConfig.column]; let bVal = b[sortConfig.column];
                    if (sortConfig.column === 'data') { aVal = new Date(aVal); bVal = new Date(bVal); }
                    if (sortConfig.column === 'acr') { aVal = a.acrFull; bVal = b.acrFull; }
                    
                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const renderTable = (data) => {
                tableBody.innerHTML = '';
                const sorted = sortData(data, currentSort);
                let lastGerencia = null;

                sorted.forEach((item, index) => {
                    if (item.gerencia !== lastGerencia) {
                        const groupRow = document.createElement('tr');
                        groupRow.innerHTML = `<td colspan="3" class="p-1"><div class="px-4 py-2 bg-gray-100 text-gray-800 font-bold text-sm rounded-md">${item.gerencia}</div></td>`;
                        tableBody.appendChild(groupRow);
                        lastGerencia = item.gerencia;
                    }

                    const dataRow = document.createElement('tr');
                    dataRow.className = 'hover:bg-green-50 clickable-row';
                    dataRow.dataset.targetId = `details-${index}`;
                    
                    dataRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.responsavel} (${item.pas.length}) ▼</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.acr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(item.data)}</td>
                    `;
                    tableBody.appendChild(dataRow);
                    
                    const detailsRow = document.createElement('tr');
                    detailsRow.id = `details-${index}`;
                    detailsRow.className = 'details-row';
                    let detailsHtml = '<td colspan="3" class="p-0"><div class="details-cell"><ul class="list-disc list-inside space-y-2">';
                    item.pas.forEach(pa => {
                        detailsHtml += `<li class="text-sm text-gray-600"><span class="font-semibold">${pa.id}:</span> ${pa.desc}</li>`;
                    });
                    detailsHtml += '</ul></div></td>';
                    detailsRow.innerHTML = detailsHtml;
                    tableBody.appendChild(detailsRow);
                });
            };

            tableBody.addEventListener('click', (e) => {
                const row = e.target.closest('.clickable-row');
                if (row) {
                    const targetId = row.dataset.targetId;
                    const detailsRow = document.getElementById(targetId);
                    if (detailsRow) {
                        detailsRow.classList.toggle('show');
                        const iconCell = row.querySelector('td:first-child');
                        iconCell.innerHTML = iconCell.innerHTML.includes('▼') 
                            ? iconCell.innerHTML.replace('▼', '▲')
                            : iconCell.innerHTML.replace('▲', '▼');
                    }
                }
            });

            const updateDashboard = () => {
                if (currentView === 'atrasadas') {
                    renderChart(dadosAtrasados, 'PAs Atrasados', CMPC_GRAY);
                    renderTable(dadosAtrasados);
                    tabAtrasadas.classList.replace('tab-inactive', 'tab-active');
                    tabAVencer.classList.replace('tab-active', 'tab-inactive');
                } else {
                    renderChart(dadosAVencer, 'PAs a Vencer', CMPC_DARK_GREEN);
                    renderTable(dadosAVencer);
                    tabAVencer.classList.replace('tab-inactive', 'tab-active');
                    tabAtrasadas.classList.replace('tab-active', 'tab-inactive');
                }
            };
            
            const updateKpis = () => {
                totalAtrasadasEl.textContent = calculatePAs(dadosAtrasados);
                totalAVencerEl.textContent = calculatePAs(dadosAVencer);
            };

            tabAtrasadas.addEventListener('click', () => { currentView = 'atrasadas'; updateDashboard(); });
            tabAVencer.addEventListener('click', () => { currentView = 'a-vencer'; updateDashboard(); });
            
            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if(!column) return;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    tableHeaders.forEach(h => { if(h.dataset.sort) h.querySelector('.sort-indicator').style.opacity = '0'});
                    header.querySelector('.sort-indicator').style.opacity = '1';
                    
                    const dataToRender = currentView === 'atrasadas' ? dadosAtrasados : dadosAVencer;
                    renderTable(dataToRender);
                });
            });

            document.getElementById('generation-date').textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            updateKpis();
            updateDashboard();
        });
    </script>
</body>
</html>

